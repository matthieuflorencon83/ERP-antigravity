{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block extra_css %}
    <!-- Styles loaded from static/css/styles.css -->
{% endblock %}
{% block content %}
    <div class="container-fluid p-4 bg-body-tertiary min-vh-100">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold mb-1 ls-tight">
                    Tableau de Bord
                </h1>
                <p class="text-muted small">
                    Vue d'ensemble de l'activit√©.
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'ventes:besoins_affaire' '1' %}"
                   class="btn btn-sm btn-dark shadow-sm">
                    <i class="bi bi-plus-lg me-1"></i> Saisie Rapide
                </a>
                <button class="btn btn-sm btn-white border shadow-sm"
                        onclick="location.reload()"
                        title="Actualiser">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
        <!-- KPI ROW -->
        <div class="row g-4 mb-5">
            <!-- KPI 1: Pipeline Ventes -->
            <div class="col-xl-3 col-sm-6">
                <div class="dashboard-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="icon-box bg-gradient-primary-subtle">
                                <i class="bi bi-currency-euro"></i>
                            </div>
                            <span class="badge bg-primary-subtle text-primary rounded-pill">+12%</span>
                        </div>
                        <h6 class="text-muted text-uppercase fs-xs fw-bold ls-1 mb-1">
                            Pipeline Ventes
                        </h6>
                        <div class="h3 fw-bold mb-0 text-dark">
                            {{ kpi.total_pipeline_ventes|floatformat:0 }} ‚Ç¨
                        </div>
                        <div class="mt-2 text-muted small">
                            <span class="text-dark fw-bold">{{ kpi.nb_affaires_cours }}</span> affaires en cours
                        </div>
                    </div>
                </div>
            </div>
            <!-- KPI 2: Pipeline Achats -->
            <div class="col-xl-3 col-sm-6">
                <div class="dashboard-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="icon-box bg-gradient-warning-subtle">
                                <i class="bi bi-cart"></i>
                            </div>
                            <span class="badge bg-warning-subtle text-warning rounded-pill">Encours</span>
                        </div>
                        <h6 class="text-muted text-uppercase fs-xs fw-bold ls-1 mb-1">
                            Engagements Achats
                        </h6>
                        <div class="h3 fw-bold mb-0 text-dark">
                            {{ kpi.total_pipeline_achats|floatformat:0 }} ‚Ç¨
                        </div>
                        <div class="mt-2 text-muted small">
                            <span class="text-dark fw-bold">{{ kpi.nb_commandes_cours }}</span> commandes actives
                        </div>
                    </div>
                </div>
            </div>
            <!-- KPI 3: Devis √† Relancer -->
            <div class="col-xl-3 col-sm-6">
                <div class="dashboard-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="icon-box bg-gradient-success-subtle px-3 w-auto">
                                <i class="bi bi-file-earmark-text me-2"></i> {{ kpi.nb_devis_attente }}
                            </div>
                        </div>
                        <h6 class="text-muted text-uppercase fs-xs fw-bold ls-1 mb-1">
                            Devis en Attente
                        </h6>
                        <div class="d-flex align-items-center gap-2 mt-3">
                            <a href="#" class="btn btn-sm btn-outline-success w-100">Voir les Devis</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- KPI 4: Actions Requises -->
            <div class="col-xl-3 col-sm-6">
                <div class="dashboard-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="icon-box bg-gradient-danger-subtle">
                                <i class="bi bi-exclamation-lg"></i>
                            </div>
                        </div>
                        <h6 class="text-muted text-uppercase fs-xs fw-bold ls-1 mb-1">
                            Actions Requises
                        </h6>
                        <div class="d-flex flex-column gap-1 mt-2">
                            {% if kpi.nb_brouillons > 0 %}
                                <a href="{% url 'achats:commande_list' %}?statut=BROUILLON"
                                   class="text-decoration-none text-danger small fw-bold">
                                    ‚Ä¢ {{ kpi.nb_brouillons }} Commandes Brouillon
                                </a>
                            {% endif %}
                            {% if kpi.nb_arc_manquant > 0 %}
                                <a href="{% url 'achats:commande_list' %}?statut=ENVOYEE"
                                   class="text-decoration-none text-warning small fw-bold">
                                    ‚Ä¢ {{ kpi.nb_arc_manquant }} ARC Manquants
                                </a>
                            {% endif %}
                            {% if kpi.nb_brouillons == 0 and kpi.nb_arc_manquant == 0 %}
                                <span class="text-success small fw-bold">Rien √† signaler. üëç</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- MAIN GRID -->
        <div class="row g-4">
            <!-- LEFT: Recent Activity (Affaires & Commandes) -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white border-0 py-3 px-4">
                        <h6 class="mb-0 fw-bold">
                            Activit√© R√©cente
                        </h6>
                    </div>
                    <div class="card-body px-0 pt-0">
                        <ul class="nav nav-tabs nav-tabs-modern px-4 mb-3"
                            id="activityTab"
                            role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-bold small"
                                        id="orders-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#orders"
                                        type="button"
                                        role="tab"
                                        aria-selected="true">
                                    Derni√®res Commandes
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold small"
                                        id="projects-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#projects"
                                        type="button"
                                        role="tab"
                                        aria-selected="false">
                                    Chantiers R√©cents
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content px-4" id="activityTabContent">
                            <!-- TAB: COMMANDES -->
                            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dashboard table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>
                                                    R√©f. / Date
                                                </th>
                                                <th>
                                                    Fournisseur
                                                </th>
                                                <th>
                                                    Affaire
                                                </th>
                                                <th class="text-end">
                                                    Montant
                                                </th>
                                                <th class="text-end">
                                                    Statut
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cmd in latest_commandes %}
                                                <tr>
                                                    <td>
                                                        <div class="fw-bold text-dark">
                                                            {{ cmd.numero_bdc|default:"Brouillon" }}
                                                        </div>
                                                        <div class="small text-muted">
                                                            {{ cmd.date_creation|date:"d/m/Y" }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="avatar-circle small bg-primary-subtle text-primary fw-bold avatar-xs">
                                                                {{ cmd.fournisseur.nom_fournisseur|slice:":1" }}
                                                            </div>
                                                            <span class="fw-medium text-dark">{{ cmd.fournisseur.nom_fournisseur
                                                            }}</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-light text-dark border">{{
                                                        cmd.affaire.nom_affaire|truncatechars:20 }}</span>
                                                    </td>
                                                    <td class="text-end fw-bold">
                                                        {{ cmd.total_ht|floatformat:2 }} ‚Ç¨
                                                    </td>
                                                    <td class="text-end">
                                                        {% if cmd.statut == 'BROUILLON' %}
                                                            <span class="badge bg-secondary-subtle text-secondary rounded-pill">Brouillon</span>
                                                        {% elif cmd.statut == 'ENVOYEE' %}
                                                            <span class="badge bg-warning-subtle text-warning rounded-pill">Envoy√©e</span>
                                                        {% elif cmd.statut == 'LIVREE' %}
                                                            <span class="badge bg-success-subtle text-success rounded-pill">Livr√©e</span>
                                                        {% else %}
                                                            <span class="badge bg-info-subtle text-info rounded-pill">{{
                                                            cmd.get_statut_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center py-4 text-muted">
                                                        Aucune commande r√©cente.
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- TAB: AFFAIRES -->
                            <div class="tab-pane fade" id="projects" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="table table-dashboard table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>
                                                    Nom / Client
                                                </th>
                                                <th>
                                                    Date Cr√©ation
                                                </th>
                                                <th class="text-center">
                                                    Satut
                                                </th>
                                                <th class="text-end">
                                                    Ventes HT
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for aff in latest_affaires %}
                                                <tr>
                                                    <td>
                                                        <div class="fw-bold text-dark">
                                                            {{ aff.nom_affaire }}
                                                        </div>
                                                        <div class="small text-muted">
                                                            {{ aff.client.nom }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {{ aff.date_creation|date:"d M Y" }}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if aff.statut == 'EN_COURS' %}
                                                            <span class="badge bg-primary-subtle text-primary">En Cours</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary-subtle text-secondary">{{
                                                            aff.get_statut_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end fw-bold">
                                                        {{ aff.total_vente_ht|floatformat:0 }} ‚Ç¨
                                                    </td>
                                                </tr>
                                            {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center py-4 text-muted">
                                                        Aucune affaire r√©cente.
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- RIGHT: Quick Tools & Status -->
            <div class="col-lg-4">
                <!-- Quick Actions -->
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white border-0 py-3 px-4">
                        <h6 class="mb-0 fw-bold">
                            Outils Rapides
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="list-group list-group-flush">
                            <a href="{% url 'upload_document' %}"
                               class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3 border-0 rounded-3">
                                <div class="icon-box bg-dark text-white shadow-sm icon-md">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark">
                                        Scan Documents
                                    </h6>
                                    <small class="text-muted">Analyser PDF/Factures</small>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                            </a>
                            <a href="{% url 'catalogue:article_list' %}"
                               class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3 border-0 rounded-3">
                                <div class="icon-box bg-white border text-dark icon-md">
                                    <i class="bi bi-box-seam"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark">
                                        Catalogue
                                    </h6>
                                    <small class="text-muted">G√©rer les articles</small>
                                </div>
                                <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- System Status (Simple) -->
                <div class="card border-0 shadow-sm rounded-4 bg-primary text-white overflow-hidden position-relative">
                    <!-- Decorative Circle -->
                    <div class="position-absolute top-0 end-0 translate-middle rounded-circle bg-white opacity-10 circle-decoration">
                    </div>
                    <div class="card-body p-4 position-relative z-1">
                        <h5 class="fw-bold mb-1">
                            Syst√®me Op√©rationnel
                        </h5>
                        <p class="opacity-75 small mb-4">
                            Derni√®re sauvegarde : Aujourd'hui 04:00
                        </p>
                        <button class="btn btn-sm btn-white text-primary fw-bold shadow-sm"
                                hx-get="{% url 'settings' %}"
                                hx-push-url="true">
                            <i class="bi bi-gear-fill me-1"></i> Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
