{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .fs-07 {
        font-size: 0.7rem;
    }

    .fs-065 {
        font-size: 0.65rem;
    }
</style>
<div class="container-fluid p-4 min-vh-100 bg-body-tertiary">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h3 fw-bold mb-1 ls-tight">Vue Satellite Approvisionnements</h1>
            <p class="text-muted small">Suivi global des commandes par chantier (ADN).</p>
        </div>
        <div>
            <a href="{% url 'achats:commande_list' %}" class="btn btn-white border shadow-sm">
                <i class="bi bi-list-ul me-2"></i> Vue Liste
            </a>
        </div>
    </div>

    <!-- Grid -->
    <div class="row g-4">
        {% for item in portfolio_data %}
        <div class="col-xl-3 col-lg-4 col-md-6">
            <a href="{% url 'ventes:besoins_affaire' item.affaire.id %}" class="text-decoration-none">
                <div
                    class="card h-100 border-0 shadow-sm rounded-4 card-hover transition-all {% if item.has_alert %}border border-danger border-2{% endif %}">
                    <div class="card-body p-4">
                        <!-- Top: Chantier Info -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="fw-bold text-dark mb-1">{{ item.affaire.nom_affaire|truncatechars:25 }}</h6>
                                <div class="small text-muted">{{ item.affaire.client.nom|default:"Client Inconnu" }}
                                </div>
                            </div>
                            {% if item.has_alert %}
                            <span class="badge bg-danger-subtle text-danger rounded-pill animate-pulse">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i> Retard
                            </span>
                            {% else %}
                            <span class="badge bg-light text-dark border rounded-pill">
                                {{ item.stats.total }} Cde{{ item.stats.total|pluralize }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Middle: Jauge ADN (DNA Gauge) -->
                        <div class="mt-4 mb-2">
                            <style>
                                .w-dyn {
                                    width: var(--w-dyn);
                                }
                            </style>
                            <div class="d-flex justify-content-between small fw-bold text-muted mb-1 fs-07">
                                <span>Progression Appro.</span>
                                <span>100%</span>
                            </div>
                            <div class="progress-stacked" style="height: 12px; border-radius: 6px; overflow: hidden;">
                                <!-- 1. Commandes Livrées (Vert - Succès) -->
                                {% if item.jauge.pct_livree > 0 %}
                                <div class="progress" role="progressbar" style="--w-dyn: {{ item.jauge.pct_livree }}%"
                                    aria-label="Pourcentage Commandes Livrées"
                                    aria-valuenow="{{ item.jauge.pct_livree|default:0|floatformat:0 }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                    <div class="progress-bar bg-success w-dyn"></div>
                                </div>
                                {% endif %}

                                <!-- 2. Commandes ARC (Bleu - Primary) -->
                                {% if item.jauge.pct_arc > 0 %}
                                <div class="progress" role="progressbar" style="--w-dyn: {{ item.jauge.pct_arc }}%"
                                    aria-label="Pourcentage Commandes ARC"
                                    aria-valuenow="{{ item.jauge.pct_arc|default:0|floatformat:0 }}" aria-valuemin="0"
                                    aria-valuemax="100">
                                    <div class="progress-bar bg-primary w-dyn"></div>
                                </div>
                                {% endif %}

                                <!-- 3. Commandes Envoyées (Jaune - Warning) -->
                                {% if item.jauge.pct_envoyee > 0 %}
                                <div class="progress" role="progressbar" style="--w-dyn: {{ item.jauge.pct_envoyee }}%"
                                    aria-label="Pourcentage Commandes Envoyées"
                                    aria-valuenow="{{ item.jauge.pct_envoyee|default:0|floatformat:0 }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                    <div class="progress-bar bg-warning w-dyn"></div>
                                </div>
                                {% endif %}

                                <!-- 4. Brouillons (Gris - Secondary) -->
                                {% if item.jauge.pct_brouillon > 0 %}
                                <div class="progress" role="progressbar"
                                    style="--w-dyn: {{ item.jauge.pct_brouillon }}%" aria-label="Pourcentage Brouillons"
                                    aria-valuenow="{{ item.jauge.pct_brouillon|default:0|floatformat:0 }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                    <div class="progress-bar bg-secondary opacity-50 w-dyn"></div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Bottom: Legend / Mini Stats -->
                        <div class="row g-1 mt-3">
                            <div class="col-3 text-center border-end">
                                <div class="fs-xs fw-bold text-success">{{ item.stats.nb_livree }}</div>
                                <div class="text-muted fs-065">Livrées</div>
                            </div>
                            <div class="col-3 text-center border-end">
                                <div class="fs-xs fw-bold text-primary">{{ item.stats.nb_arc }}</div>
                                <div class="text-muted fs-065">ARC</div>
                            </div>
                            <div class="col-3 text-center border-end">
                                <div class="fs-xs fw-bold text-warning">{{ item.stats.nb_envoyee }}</div>
                                <div class="text-muted fs-065">Envoyées</div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="fs-xs fw-bold text-secondary">{{ item.stats.nb_brouillon }}</div>
                                <div class="text-muted fs-065">Prep.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <div class="icon-box bg-light text-muted rounded-circle mx-auto mb-3" style="width:64px; height:64px;">
                <i class="bi bi-inbox fs-2"></i>
            </div>
            <h5 class="text-muted">Aucune commande active.</h5>
            <p class="small text-muted">Créez des commandes depuis les Besoins Chantier pour voir apparaître les jauges.
            </p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}