<div class="card-body p-4">
    <!-- STEPPER TIMELINE -->
    <style>
        .progress-dynamic {
            width: var(--progress-width, 0%);
        }
    </style>
    <div class="position-relative mb-5 mx-4">
        <div class="progress" style="height: 2px;">
            <div class="progress-bar bg-primary progress-dynamic" role="progressbar"
                style="--progress-width: {{ commande.progression_pourcentage|floatformat:0 }}%;"
                aria-valuenow="{{ commande.progression_pourcentage|default:0|floatformat:0 }}" aria-valuemin="0"
                aria-valuemax="100" aria-label="Progression de la commande">
            </div>
        </div>

        <!-- Step 1: Brouillon -->
        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm rounded-pill 
            {% if commande.statut == 'BROUILLON' %}btn-primary{% else %}btn-secondary{% endif %} top-0">
            1
        </div>

        <!-- Step 2: Envoyée -->
        <div class="position-absolute top-0 start-25 translate-middle btn btn-sm rounded-pill 
            {% if commande.statut == 'ENVOYEE' %}btn-primary{% else %}btn-secondary{% endif %} left-25">
            2
        </div>

        <!-- Step 3: Vérification (IA) -->
        <div class="position-absolute top-0 start-50 translate-middle btn btn-sm rounded-pill 
            {% if commande.statut == 'CONFIRME_ARC' or commande.statut == 'LIVREE' %}btn-primary{% else %}btn-secondary{% endif %} left-50"
            title="Vérification ARC">
            3
        </div>

        <!-- Step 4: Confirmée -->
        <div class="position-absolute top-0 start-75 translate-middle btn btn-sm rounded-pill 
            {% if commande.statut == 'CONFIRME_ARC' %}btn-primary{% else %}btn-secondary{% endif %} left-75">
            4
        </div>

        <!-- Step 5: Livrée -->
        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm rounded-pill 
            {% if commande.statut == 'LIVREE' %}btn-primary{% else %}btn-secondary{% endif %} left-100">
            5
        </div>

        <!-- Labels -->
        <div
            class="d-flex justify-content-between mt-2 small fw-bold text-uppercase ls-1 text-muted pixel-perfect-labels">
            <span>Brouillon</span>
            <span>Envoyée</span>
            <span>Vérif.</span>
            <span>Confirmée</span>
            <span>Livrée</span>
        </div>
    </div>

    <!-- CONTEXTUAL ACTIONS -->
    <div
        class="d-flex flex-column align-items-center justify-content-center p-4 bg-light rounded-3 border-dashed border-2">
        {% if commande.statut == 'BROUILLON' %}
        <div class="text-center">
            <h6 class="fw-bold mb-2">Commande prête à envoyer ?</h6>
            <p class="small text-muted mb-3">Vérifiez les lignes ci-dessous avant de valider.</p>
            <button class="btn btn-primary shadow-sm"
                hx-post="{% url 'achats:htmx_update_statut_commande' commande.id 'ENVOYEE' %}" hx-target="#status-area"
                hx-swap="outerHTML">
                <i class="bi bi-send me-2"></i> Marquer comme Envoyée
            </button>
        </div>
        {% elif commande.statut == 'ENVOYEE' %}
        <div class="text-center w-100">
            <h6 class="fw-bold mb-2 text-primary">En attente de l'ARC</h6>
            <p class="small text-muted mb-3">Glissez l'Accusé de Réception de Commande (PDF/Image) ici pour valider.</p>

            <form hx-post="{% url 'achats:upload_document_commande' commande.id %}" hx-encoding="multipart/form-data"
                hx-target="#status-area" hx-swap="outerHTML" class="file-drop-zone">
                <input type="hidden" name="doc_type" value="ARC">
                <label for="arc-upload" class="visually-hidden">Télécharger l'ARC</label>
                <input type="file" id="arc-upload" name="document" class="form-control"
                    aria-label="Télécharger l'Accusé de Réception de Commande" onchange="this.form.requestSubmit()">
            </form>
        </div>
        {% elif commande.statut == 'CONFIRME_ARC' %}
        <div class="text-center w-100">
            <h6 class="fw-bold mb-2 text-success">Commande Confirmée</h6>
            <p class="small text-muted mb-3">En attente de livraison. Glissez le Bon de Livraison (BL) ici.</p>

            <form hx-post="{% url 'achats:upload_document_commande' commande.id %}" hx-encoding="multipart/form-data"
                hx-target="#status-area" hx-swap="outerHTML" class="file-drop-zone">
                <input type="hidden" name="doc_type" value="BL">
                <label for="bl-upload" class="visually-hidden">Télécharger le BL</label>
                <input type="file" id="bl-upload" name="document" class="form-control"
                    aria-label="Télécharger le Bon de Livraison" onchange="this.form.requestSubmit()">
            </form>
        </div>
        {% elif commande.statut == 'LIVREE' %}
        <div class="text-center">
            <div class="icon-box bg-success text-white rounded-circle mb-3 mx-auto">
                <i class="bi bi-check-lg display-6"></i>
            </div>
            <h6 class="fw-bold text-success mb-1">Livraison Effectuée</h6>
            <p class="small text-muted">La commande est clôturée.</p>
        </div>
        {% endif %}
    </div>
</div>