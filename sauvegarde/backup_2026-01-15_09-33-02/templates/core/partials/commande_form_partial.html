{% load custom_filters %}
<div class="h-100 d-flex flex-column">
    <!-- Header -->
    <div class="p-4 border-bottom bg-light">
        <h5 class="mb-1 fw-bold text-dark">
            {% if form.instance.pk %}
                <i class="bi bi-pencil-square me-2 text-primary"></i>Commande {{ form.instance.numero_bdc }}
            {% else %}
                <i class="bi bi-plus-circle me-2 text-success"></i>Nouvelle Commande
            {% endif %}
        </h5>
        <div class="small text-muted">
            {% if form.instance.pk %}
                ID: {{ form.instance.pk }}
            {% else %}
                Créez une nouvelle commande manuelle.
            {% endif %}
        </div>
    </div>
    <!-- Scrollable Form Body -->
    <div class="flex-grow-1 overflow-y-auto p-4">
        <form id="commande-form"
              hx-post="{% if form.instance.pk %}
                           {% url 'commande_edit' form.instance.pk %}
                       {% else %}
                           {% url 'commande_create' %}
                       {% endif %}"
              hx-target="#detailSidebarContent"
              hx-swap="innerHTML">
            {% csrf_token %}
            <!-- SECTION 1: ENTÊTE -->
            <h6 class="text-uppercase text-secondary fw-bold fs-xs mb-3 ls-1">
                Informations Principales
            </h6>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label small fw-bold">
                        Numéro BDC
                    </label>
                    {{ form.numero_bdc|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold">
                        Date Commande
                    </label>
                    {{ form.date_commande|add_class:"form-control form-control-sm" }}
                </div>
                <div class="col-md-12">
                    <label class="form-label small fw-bold">
                        Affaire / Chantier
                    </label>
                    {{ form.affaire|add_class:"form-select form-select-sm" }}
                    <div class="form-text fs-xs">
                        L'affaire lie le client à la commande.
                    </div>
                </div>
                <div class="col-md-12">
                    <label class="form-label small fw-bold">
                        Statut
                    </label>
                    {{ form.statut|add_class:"form-select form-select-sm" }}
                </div>
            </div>
            <!-- SECTION 2: LIGNES DE COMMANDE -->
            <h6 class="text-uppercase text-secondary fw-bold fs-xs mb-3 ls-1 d-flex justify-content-between align-items-center">
                Lignes de commande
                {% if form.instance.pk %}
                    <span class="badge bg-secondary-subtle text-secondary rounded-pill">{{ lines|length }}</span>
                {% endif %}
            </h6>
            {% if form.instance.pk %}
                {% if lines %}
                    <div class="table-responsive border rounded bg-white">
                        <table class="table table-sm table-striped mb-0 small">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        Article
                                    </th>
                                    <th class="text-center">
                                        Qté
                                    </th>
                                    <th class="text-end">
                                        P.U.
                                    </th>
                                    <th class="text-end">
                                        Total
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in lines %}
                                    <tr>
                                        <td>
                                            <div class="fw-medium text-truncate" style="max-width: 150px;">
                                                {{
                                                line.article.designation }}
                                            </div>
                                            <div class="text-muted fs-xs">
                                                {{ line.article.ref_fournisseur }}
                                            </div>
                                        </td>
                                        <td class="text-center align-middle">
                                            {{ line.quantite }}
                                        </td>
                                        <td class="text-end align-middle">
                                            {{ line.prix_unitaire_ht }} €
                                        </td>
                                        <td class="text-end align-middle fw-bold">
                                            {{ line.total_ligne|floatformat:2 }} €
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light fw-bold">
                                <tr>
                                    <td colspan="3" class="text-end">
                                        Total HT
                                    </td>
                                    <td class="text-end">
                                        {{ form.instance.prix_total_ht }} €
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-muted small fst-italic border rounded p-3 text-center bg-light">
                        Aucune ligne de commande.
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info small">
                    <i class="bi bi-info-circle me-1"></i> Enregistrez la commande pour ajouter des lignes.
                </div>
            {% endif %}
            <!-- Hidden generic error display -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger small mt-3">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
        </form>
    </div>
    <!-- Sticky Footer Actions -->
    <div class="p-3 bg-light border-top d-flex gap-2 justify-content-end">
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                onclick="toggleDetailPanel(false)">
            Annuler
        </button>
        {% if form.instance.pk %}
            <button type="button"
                    class="btn btn-sm btn-outline-danger me-auto"
                    hx-delete="{% url 'commande_edit' form.instance.pk %}"
                    hx-confirm="Supprimer cette commande ?"
                    hx-target="body"
                    hx-swap="outerHTML">
                <i class="bi bi-trash"></i>
            </button>
        {% endif %}
        <button type="submit"
                form="commande-form"
                class="btn btn-sm btn-primary px-4 fw-bold">
            <i class="bi bi-check-lg me-1"></i> Enregistrer
        </button>
    </div>
</div>
