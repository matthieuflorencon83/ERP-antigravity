Creating test database for alias 'default'...
F
======================================================================
FAIL: test_client_list (tests.test_tiers_ui.ClientUIFlowTest.test_client_list)
Test the client list view
----------------------------------------------------------------------
Traceback (most recent call last):
  File "C:\Antigravity\Matt Dev\ERP\tests\test_tiers_ui.py", line 25, in test_client_list
    self.assertContains(response, "CLI001")
    ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
AssertionError: False is not true : Couldn't find 'CLI001' in the following response
b'<!DOCTYPE html>\n<html lang="fr" data-bs-theme="light">\n\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    \n    <title>Antigravity ERP</title>\n    <!-- Bootstrap 5.3 CSS -->\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">\n    <!-- Bootstrap Icons -->\n    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">\n    <!-- Custom Styles -->\n    <link rel="stylesheet" href="/static/css/styles.css">\n    \n<style>\n    /* CUSTOM PAGE STYLES - Antigravity Pro 2.0 */\n    /* (Ported from article_list.html for consistency) */\n\n    /* 1. LAYOUT & SCROLLING */\n    .page-container {\n        height: 100%;\n        display: flex;\n        flex-direction: column;\n        padding: 1.5rem 2rem;\n        background-color: var(--bs-tertiary-bg);\n        overflow: hidden;\n    }\n\n    /* 2. DATAGRID CARD */\n    .datagrid-card {\n        border: 1px solid var(--bs-border-color) !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04) !important;\n        border-radius: 12px;\n        background: var(--bs-body-bg);\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n    }\n\n    /* 3. TOOLBAR */\n    .toolbar-area {\n        padding: 1rem 1.25rem;\n        border-bottom: 1px solid var(--bs-border-color);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: 1rem;\n        background: var(--bs-body-bg);\n    }\n\n    .search-input-group {\n        width: 300px;\n    }\n\n    .search-input {\n        border-radius: 8px 0 0 8px !important;\n        border-right: none;\n        background-color: var(--bs-tertiary-bg);\n        border-color: var(--bs-border-color);\n    }\n\n    .search-btn {\n        border-radius: 0 8px 8px 0 !important;\n        background-color: var(--bs-tertiary-bg);\n        border-left: none;\n        color: var(--bs-secondary-color);\n        border-color: var(--bs-border-color);\n    }\n\n    .filter-pill {\n        border-radius: 20px;\n        font-size: 0.85rem;\n        font-weight: 500;\n        padding: 0.4rem 1rem;\n        color: var(--bs-secondary-color);\n        background-color: var(--bs-body-bg);\n        border: 1px solid var(--bs-border-color);\n        transition: all 0.2s;\n        cursor: pointer;\n        text-decoration: none;\n    }\n\n    .filter-pill:hover,\n    .filter-pill.active {\n        background-color: var(--bs-primary-bg-subtle);\n        color: var(--bs-primary);\n        border-color: var(--bs-primary-border-subtle);\n    }\n\n    /* 4. TABLE STYLES */\n    .table-container {\n        flex: 1;\n        overflow-y: auto;\n        position: relative;\n    }\n\n    .table-modern {\n        margin-bottom: 0;\n        width: 100%;\n        font-size: 0.9rem;\n    }\n\n    .table-modern thead th {\n        position: sticky;\n        top: 0;\n        background-color: var(--bs-tertiary-bg);\n        color: var(--bs-secondary-color);\n        font-weight: 600;\n        font-size: 0.75rem;\n        text-transform: uppercase;\n        letter-spacing: 0.05em;\n        padding: 0.75rem 1.25rem;\n        border-bottom: 1px solid var(--bs-border-color);\n        z-index: 10;\n        white-space: nowrap;\n    }\n\n    .table-modern tbody td {\n        padding: 0.65rem 1.25rem;\n        border-bottom: 1px solid var(--bs-border-color);\n        vertical-align: middle;\n    }\n\n    .table-modern tbody tr {\n        transition: background-color 0.1s;\n    }\n\n    .table-modern tbody tr:hover {\n        background-color: var(--bs-tertiary-bg);\n    }\n\n    /* Row Actions */\n    .row-actions {\n        opacity: 0;\n        transition: opacity 0.2s ease-in-out;\n        display: flex;\n        gap: 0.5rem;\n        justify-content: flex-end;\n    }\n\n    .table-modern tbody tr:hover .row-actions {\n        opacity: 1;\n    }\n\n    .action-btn {\n        width: 32px;\n        height: 32px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 6px;\n        color: var(--bs-secondary-color);\n        transition: all 0.2s;\n    }\n\n    .action-btn:hover {\n        background-color: var(--bs-secondary-bg);\n        color: var(--bs-primary);\n    }\n\n    /* Badge Pills */\n    .badge-pill-text {\n        font-weight: 600;\n        padding: 0.35em 0.8em;\n        border-radius: 6px;\n        font-size: 0.75rem;\n    }\n</style>\n\n    <style>\n        /* THEME INIT : BLOCKING TO PREVENT FLASH */\n        html {\n            visibility: hidden;\n            opacity: 0;\n        }\n    </style>\n    <script>\n        // Immediately Applied Theme Logic (Blocking)\n        (function () {\n            const savedTheme = localStorage.getItem(\'theme\') || \'light\';\n            document.documentElement.setAttribute(\'data-bs-theme\', savedTheme);\n            // Restore visibility immediately after theme is set\n            const style = document.createElement(\'style\');\n            style.innerHTML = \'html { visibility: visible; opacity: 1; }\';\n            document.head.appendChild(style);\n        })();\n    </script>\n    <style>\n        /* Global Loader */\n        .htmx-indicator-global {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 3px;\n            background: linear-gradient(90deg, #0d6efd, #6610f2);\n            z-index: 9999;\n            animation: loader-anim 1s infinite linear;\n        }\n\n        @keyframes loader-anim {\n            0% {\n                transform: translateX(-100%);\n            }\n\n            100% {\n                transform: translateX(100%);\n            }\n        }\n\n        .htmx-request .htmx-indicator-global {\n            display: block;\n        }\n\n        .htmx-request.htmx-indicator-global {\n            display: block;\n        }\n\n        body {\n            height: 100vh;\n            /* Was min-height */\n            overflow: hidden;\n            /* Prevent global scroll */\n        }\n\n        /* Sidebar styling */\n        .sidebar {\n            width: 280px !important;\n            --bs-offcanvas-width: 280px;\n            height: 100vh;\n            position: fixed;\n            top: 0;\n            left: 0;\n            z-index: 1045;\n            /* Match Bootstrap offcanvas z-index */\n            border-right: 1px solid var(--bs-border-color);\n            display: flex;\n            flex-direction: column;\n            background-color: var(--bs-body-bg);\n            transition: transform 0.3s ease-in-out;\n        }\n\n        .main-content {\n            margin-left: 280px;\n            /* Flex layout to handle dynamic topbar height */\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n            overflow: hidden;\n            transition: margin-left 0.3s ease-in-out;\n            /* container handles scroll usually */\n        }\n\n        #app-content {\n            flex: 1;\n            /* Allow content to scroll or be container for full-height apps */\n            overflow: auto;\n            padding: 0 !important;\n            /* Let children handle padding if needed for full screen apps */\n        }\n\n        /* Re-add padding for normal pages if needed via a utility or default block */\n        .page-padding {\n            padding: 1.5rem;\n        }\n\n        /* Transition moved to .main-content rule above if valid, or removing stray text */\n\n        /* Mobile Sidebar behavior (default offcanvas behavior is good, but we need overrides for Desktop) */\n        /* On Desktop (>= 992px), force visibility and reset transform */\n        @media (min-width: 992px) {\n            .sidebar {\n                transform: none !important;\n                visibility: visible !important;\n            }\n        }\n\n        /* Mobile Layout (< 992px) */\n        @media (max-width: 991.98px) {\n\n            /* Sidebar is handled by Bootstrap offcanvas classes for hiding/showing */\n            /* We just need to ensure main content uses full width */\n            .main-content {\n                margin-left: 0;\n            }\n        }\n\n        .nav-link {\n            color: var(--bs-body-color);\n            padding: 0.8rem 1rem;\n            border-radius: 0.5rem;\n            margin-bottom: 0.2rem;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n        }\n\n        /* Topbar - Reduced for space */\n        .topbar {\n            min-height: 0;\n            padding: 0.5rem 1.5rem;\n            border-bottom: 1px solid var(--bs-border-color);\n            background-color: var(--bs-body-bg);\n            display: flex;\n            /* Keep flex for actions if any */\n            justify-content: flex-end;\n            /* Align actions to right */\n        }\n\n        /* Sidebar Active State - High Visibility */\n        .nav-link.active {\n            background-color: var(--bs-primary-bg-subtle);\n            color: var(--bs-primary);\n            font-weight: 700;\n            /* Bold */\n            border-left: 4px solid var(--bs-primary);\n            border-radius: 0 0.5rem 0.5rem 0;\n            /* Updated radius for left border */\n        }\n\n        .avatar-circle {\n            width: 32px;\n            height: 32px;\n        }\n\n        /* Condensed Sidebar Form Styling */\n        #detailSidebar .offcanvas-body {\n            padding: 1rem !important;\n            overflow-y: auto;\n        }\n\n        #detailSidebar form .form-group {\n            margin-bottom: 0.5rem !important;\n        }\n\n        #detailSidebar form label {\n            font-size: 0.75rem !important;\n            margin-bottom: 2px !important;\n            color: var(--bs-gray-600);\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            font-weight: 600;\n        }\n\n        #detailSidebar form .input-clean,\n        #detailSidebar form input:not([type=checkbox]),\n        #detailSidebar form select,\n        #detailSidebar form textarea {\n            font-size: 0.85rem !important;\n            padding: 0.35rem 0.6rem !important;\n            height: auto !important;\n        }\n\n        #detailSidebar form textarea {\n            min-height: 60px !important;\n        }\n\n        #detailSidebar form .btn-primary-2026 {\n            padding: 0.6rem 1rem !important;\n            font-size: 0.9rem !important;\n            margin-top: 1rem !important;\n        }\n\n        #detailSidebar form .form-text {\n            display: none;\n        }\n\n        #detailSidebar .offcanvas-header {\n            padding: 0.75rem 1rem;\n            min-height: 0;\n            border-bottom: 1px solid var(--bs-border-color);\n        }\n\n        #detailSidebar .offcanvas-title {\n            font-size: 1.1rem;\n        }\n\n        /* Fixed sidebar width */\n        .sidebar-detail-width {\n            width: 500px;\n            /* Legacy override if needed */\n        }\n\n        /* PUSH SIDEBAR STYLES */\n        .detail-panel {\n            width: 0;\n            opacity: 0;\n            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-in;\n            overflow: hidden;\n            border-left: 1px solid var(--bs-border-color);\n            position: relative;\n            z-index: 1040;\n            background-color: var(--bs-body-bg);\n            flex-shrink: 0;\n            height: 100%;\n            /* Ensure full height adoption */\n        }\n\n        .detail-panel.open {\n            width: 600px;\n            /* Requested width */\n            opacity: 1;\n        }\n\n        /* FORCE collapse even if inline width is set by JS resizer */\n        .detail-panel:not(.open) {\n            width: 0 !important;\n            padding: 0 !important;\n            overflow: hidden !important;\n        }\n\n        /* Adjust main content flex behavior */\n        .main-content {\n            transition: margin-right 0.3s;\n        }\n    </style>\n</head>\n\n<body hx-indicator=".htmx-indicator-global">\n    <!-- Global Loader -->\n    <div class="htmx-indicator-global"></div>\n    <!-- Mobile Toggle Button (Visible only on mobile) -->\n    <button class="btn btn-primary d-lg-none position-fixed top-0 start-0 m-3 z-3" type="button"\n        data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" title="Toggle Sidebar">\n        <i class="bi bi-list"></i>\n    </button>\n    <!-- Sidebar (Desktop & Mobile Offcanvas) -->\n    <!-- Removed offcanvas-lg to prevent conflict with custom fixed positioning -->\n    <div class="offcanvas offcanvas-start sidebar" tabindex="-1" id="sidebarMenu">\n        <div class="d-flex align-items-center p-4 border-bottom">\n            <i class="bi bi-box-seam-fill text-primary fs-3 me-2"></i>\n            <span class="fs-4 fw-bold">Antigravity</span>\n            <button type="button" class="btn-close d-lg-none ms-auto" data-bs-dismiss="offcanvas"\n                data-bs-target="#sidebarMenu" aria-label="Close"></button>\n        </div>\n        <div class="flex-grow-1 p-3 overflow-y-auto">\n            <nav class="nav flex-column">\n                <a class="nav-link " href="/">\n                    <i class="bi bi-speedometer2"></i> Dashboard\n                </a>\n                <a class="nav-link "\n                    href="/documents/upload/">\n                    <i class="bi bi-cpu"></i> IA & Documents\n                </a>\n                <!-- Fournisseurs Submenu -->\n                <div class="nav-item">\n                    <div class="d-flex align-items-center">\n                        <a class="nav-link flex-grow-1 "\n                            href="/fournisseurs/">\n                            <i class="bi bi-truck"></i> Fournisseurs\n                        </a>\n                        <a class="nav-link px-2 ms-1 justify-content-center" href="#submenu-fournisseurs"\n                            data-bs-toggle="collapse" role="button"\n                            aria-expanded=" false "\n                            aria-controls="submenu-fournisseurs" title="D\xc3\xa9plier le menu Fournisseurs">\n                            <i class="bi bi-chevron-down small opacity-50"></i>\n                        </a>\n                    </div>\n                    <div class="collapse "\n                        id="submenu-fournisseurs">\n                        <nav class="nav flex-column ms-3 mt-1 border-start ps-2">\n                            <a class="nav-link small py-1 text-muted" href="javascript:void(0)"\n                                hx-get="/fournisseurs/add/" hx-target="#detailSidebarContent"\n                                hx-swap="innerHTML" onclick="toggleDetailPanel(true);">\n                                <i class="bi bi-plus text-success me-1"></i>Nouveau\n                            </a>\n                        </nav>\n                    </div>\n                </div>\n                <!-- Clients Submenu -->\n                <div class="nav-item">\n                    <div class="d-flex align-items-center">\n                        <a class="nav-link flex-grow-1 active"\n                            href="/clients/">\n                            <i class="bi bi-people"></i> Clients\n                        </a>\n                        <button class="btn btn-toggle d-flex align-items-center rounded border-0 collapsed"\n                            data-bs-toggle="collapse" data-bs-target="#submenu-clients"\n                            aria-expanded=" true "\n                            title="D\xc3\xa9plier le menu Clients">\n                            <i class="bi bi-chevron-down small opacity-50"></i>\n                        </button>\n                    </div>\n                    <div class="collapse show" id="submenu-clients">\n                        <nav class="nav flex-column ms-3 mt-1 border-start ps-2">\n                            <a class="nav-link small py-1 text-muted" href="javascript:void(0)"\n                                hx-get="/clients/add/" hx-target="#detailSidebarContent"\n                                hx-swap="innerHTML" onclick="toggleDetailPanel(true);">\n                                <i class="bi bi-plus text-success me-1"></i>Nouveau\n                            </a>\n                        </nav>\n                    </div>\n                </div>\n                <!-- Articles Submenu (Split Interaction) -->\n                <div class="nav-item">\n                    <div class="d-flex align-items-center">\n                        <a class="nav-link flex-grow-1 "\n                            href="/articles/">\n                            <i class="bi bi-box"></i> Articles\n                        </a>\n                        <a class="nav-link px-2 ms-1 justify-content-center" href="#submenu-articles"\n                            data-bs-toggle="collapse" role="button"\n                            aria-expanded=" false "\n                            aria-controls="submenu-articles" title="D\xc3\xa9plier le menu Articles">\n                            <i class="bi bi-chevron-down small opacity-50"></i>\n                        </a>\n                    </div>\n                    <div class="collapse " id="submenu-articles">\n                        <nav class="nav flex-column ms-3 mt-1 border-start ps-2">\n                            <!-- Link \'Liste\' removed as parent link handles it. Only \'Nouveau\' remains -->\n                            <a class="nav-link small py-1 text-muted" href="javascript:void(0)"\n                                hx-get="/articles/add/" hx-target="#detailSidebarContent"\n                                hx-swap="innerHTML" onclick="toggleDetailPanel(true);">\n                                <i class="bi bi-plus text-success me-1"></i>Nouveau\n                            </a>\n                        </nav>\n                    </div>\n                </div>\n                <a class="nav-link "\n                    href="/portfolio/">\n                    <i class="bi bi-cart"></i> Pilotage Achats\n                </a>\n                <!-- Affaires / Besoins (Demo) -->\n                <div class="nav-item mt-3">\n                    <span class="text-uppercase text-muted fw-bold small ps-3 mb-2 d-block fs-07">Chantiers</span>\n                    <a class="nav-link "\n                        href="/affaires/quick-entry/">\n                        <i class="bi bi-grid-3x3-gap"></i> Saisie Rapide (Stock)\n                    </a>\n                </div>\n            </nav>\n        </div>\n        <div class="p-3 border-top d-flex align-items-center justify-content-between">\n            <div class="dropdown">\n                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"\n                    data-bs-toggle="dropdown">\n                    <div\n                        class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2 avatar-circle">\n                        A\n                    </div>\n                    <strong>Admin</strong>\n                </a>\n                <ul class="dropdown-menu text-small shadow">\n                    <li>\n                        <a class="dropdown-item" href="/settings/"><i\n                                class="bi bi-gear me-2"></i>Param\xc3\xa8tres</a>\n                    </li>\n                    <li>\n                        <a class="dropdown-item" href="#">Profile</a>\n                    </li>\n                    <li>\n                        <hr class="dropdown-divider">\n                    </li>\n                    <li>\n                        <a class="dropdown-item" href="#">Sign out</a>\n                    </li>\n                </ul>\n            </div>\n            <!-- Moved Theme Toggle Here -->\n            <button class="btn btn-link nav-link px-2" id="bd-theme-toggle" type="button" title="Toggle theme">\n                <i class="bi bi-moon-stars-fill" id="theme-icon"></i>\n            </button>\n        </div>\n    </div>\n    <!-- Layout Wrapper to enable Push behavior -->\n    <div id="layout-wrapper" class="d-flex w-100 h-100 overflow-hidden">\n        <!-- Main Content -->\n        <main class="main-content flex-grow-1 min-w-0">\n            <!-- Topbar (Minimal / Optional) -->\n            \n            <header class="topbar sticky-top">\n                <!-- Page Title REMOVED for space -->\n                <!-- Only actions remain -->\n                <div class="d-flex align-items-center gap-3 w-100 justify-content-end">\n                    \n                </div>\n            </header>\n            \n            <!-- Page Content -->\n            <div class="p-4" id="app-content">\n                \n                \n<div class="page-container">\n    <!-- DATAGRID CARD -->\n    <div class="datagrid-card">\n        <!-- TOOLBAR -->\n        <div class="toolbar-area">\n            <!-- Left: Search & Filters -->\n            <div class="d-flex align-items-center gap-3">\n                <!-- Search -->\n                <div class="input-group search-input-group">\n                    <input type="text" name="q" class="form-control search-input" placeholder="Rechercher un client..."\n                        autocomplete="off" hx-get="/clients/" hx-target="#client-table-body"\n                        hx-trigger="input changed delay:50ms, search">\n                    <button class="btn btn-outline-secondary search-btn" type="button" title="Lancer la recherche">\n                        <i class="bi bi-search"></i>\n                    </button>\n                </div>\n                <!-- Filters (Visual / Future Impl) -->\n                <div class="d-flex gap-2">\n                    <a href="/clients/" class="filter-pill active">Tous</a>\n                    <a href="javascript:void(0)" class="filter-pill">Professionnels</a>\n                    <a href="javascript:void(0)" class="filter-pill">Particuliers</a>\n                </div>\n            </div>\n            <!-- Right: Actions -->\n            <div class="d-flex align-items-center gap-2">\n                <!-- Buttons are in Sidebar -->\n            </div>\n        </div>\n        <!-- TABLE HEADER (Sticky) & BODY (Scrollable) -->\n        <div class="table-container">\n            <table class="table table-modern align-middle mb-0">\n                <thead>\n                    <tr>\n                        <th class="w-30pct">Client / Soci\xc3\xa9t\xc3\xa9</th>\n                        <th class="w-15pct">Type</th>\n                        <th class="w-20pct">Contact</th>\n                        <th class="w-25pct">Localisation</th>\n                        <th class="w-10pct text-end">Actions</th>\n                    </tr>\n                </thead>\n                <tbody id="client-table-body">\n                    \n<tr class="cursor-pointer" onclick="handleRowClick(event, this)" hx-get="/clients/edit/CLI-TEST1/"\n    hx-target="#detailSidebarContent" hx-swap="innerHTML">\n    <!-- Client Name -->\n    <td>\n        <div class="d-flex align-items-center gap-3">\n            <div class="avatar-circle-sm bg-primary-subtle text-primary fw-bold">CL</div>\n            <div>\n                <div class="fw-bold text-body">Client Test UI </div>\n                <div class="text-muted small fs-075">\n                    \n                </div>\n            </div>\n        </div>\n    </td>\n    <!-- Type Badge -->\n    <td>\n        \n        <span\n            class="badge bg-purple-subtle text-purple border border-purple-subtle badge-pill-text badge-pro">PRO</span>\n        \n    </td>\n    <!-- Contact -->\n    <td>\n        \n        <div class="d-flex align-items-center gap-2 mb-1">\n            <i class="bi bi-envelope text-muted small"></i>\n            <span class="text-body small">test@test.com</span>\n        </div>\n        \n        \n    </td>\n    <!-- Address -->\n    <td>\n        \n        <span class="text-muted small italic">-</span>\n        \n    </td>\n    <!-- Actions -->\n    <td class="text-end">\n        <div class="row-actions">\n            <button class="btn btn-sm btn-icon action-btn" title="Modifier"\n                hx-get="/clients/edit/CLI-TEST1/" hx-target="#detailSidebarContent" hx-swap="innerHTML"\n                onclick="event.stopPropagation(); toggleDetailPanel(true);">\n                <i class="bi bi-pencil-fill"></i>\n            </button>\n            <button class="btn btn-sm btn-icon action-btn text-danger" title="Supprimer"\n                onclick="event.stopPropagation(); alert(\'D\xc3\xa9sactiv\xc3\xa9\')">\n                <i class="bi bi-trash"></i>\n            </button>\n        </div>\n    </td>\n</tr>\n\n                </tbody>\n            </table>\n        </div>\n        <!-- FOOTER / PAGINATION (Optional) -->\n        <div class="px-3 py-2 border-top bg-body-tertiary d-flex align-items-center justify-content-between">\n            <small class="text-muted">\n                Affichage de <strong>1</strong> clients\n            </small>\n            <!-- Pagination could go here -->\n        </div>\n    </div>\n</div>\n\n            </div>\n        </main>\n        <!-- Detail Sidebar (Right) - PUSH MODE -->\n        <!-- RESIZER HANDLE -->\n        <div id="resizer"\n            class="bg-body-tertiary border-start border-end d-flex align-items-center justify-content-center resizer-handle">\n            <i class="bi bi-three-dots-vertical text-muted opacity-50 small"></i>\n        </div>\n        <div class="detail-panel bg-body" id="detailSidebar">\n            <div class="d-flex flex-column h-100">\n                <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-body-tertiary">\n                    <h5 class="m-0 fs-6 fw-bold text-uppercase text-secondary ls-1">D\xc3\xa9tails / \xc3\x89dition</h5>\n                    <div class="d-flex gap-2">\n                        <!-- Close button acts as \'Collapse\' or \'Clear\' now, or removing it if permanent -->\n                        <button type="button" class="btn-close" onclick="toggleDetailPanel()" aria-label="Close"\n                            title="Masquer/Afficher"></button>\n                    </div>\n                </div>\n                <div id="detailSidebarContent" class="flex-grow-1 d-flex flex-column overflow-hidden">\n                    <!-- HTMX Content Loads Here -->\n                    <div class="text-center text-muted mt-5">\n                        <div class="spinner-border text-primary d-none" role="status" id="sidebarSpinner"></div>\n                        <p>Chargement...</p>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <!-- Scripts -->\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>\n    <script src="https://unpkg.com/htmx.org@1.9.10"></script>\n    <!-- Theme Toggle Script -->\n    <script>\n        /**\n         * ANTIGRAVITY ERP - MAIN SCRIPT\n         * Consolidated Logic for Theme, Sidebar, and Resizer\n         */\n\n        // --- 1. THEME MANAGEMENT ---\n        document.addEventListener(\'DOMContentLoaded\', () => {\n            const toggleBtn = document.getElementById(\'bd-theme-toggle\');\n            const icon = document.getElementById(\'theme-icon\');\n            const html = document.documentElement;\n\n            // Toggle Event\n            if (toggleBtn) {\n                toggleBtn.addEventListener(\'click\', () => {\n                    const currentTheme = html.getAttribute(\'data-bs-theme\');\n                    const newTheme = currentTheme === \'dark\' ? \'light\' : \'dark\';\n                    html.setAttribute(\'data-bs-theme\', newTheme);\n                    localStorage.setItem(\'theme\', newTheme);\n                    if (icon) updateThemeIcon(newTheme, icon);\n                });\n            }\n        });\n\n        // Helper: Update Icon (Public safe)\n        function updateThemeIcon(theme, icon) {\n            if (!icon) return;\n            if (theme === \'dark\') {\n                icon.classList.remove(\'bi-sun-fill\');\n                icon.classList.add(\'bi-moon-stars-fill\');\n            } else {\n                icon.classList.remove(\'bi-moon-stars-fill\');\n                icon.classList.add(\'bi-sun-fill\');\n            }\n        }\n\n        // --- 2. SIDEBAR STATE MANAGEMENT (Public API) ---\n\n        // Helper: safe width restoration\n        function restorePanelWidth(panel) {\n            const savedWidth = parseInt(localStorage.getItem(\'detailPanelWidth\'));\n            if (savedWidth && savedWidth > 200) {\n                // Constraints: Min 300px, Max 85% view\n                const safeW = Math.min(Math.max(savedWidth, 300), window.innerWidth * 0.85);\n                panel.style.setProperty(\'--saved-width\', safeW + \'px\');\n                panel.style.setProperty(\'width\', safeW + \'px\', \'important\');\n            }\n        }\n\n        window.toggleDetailPanel = function (forceState = null) {\n            const panel = document.getElementById(\'detailSidebar\');\n            if (!panel) return;\n\n            let isOpen = panel.classList.contains(\'open\');\n\n            if (forceState === true) {\n                panel.classList.add(\'open\');\n                isOpen = true;\n            } else if (forceState === false) {\n                panel.classList.remove(\'open\');\n                panel.style.width = \'\';\n                isOpen = false;\n            } else {\n                panel.classList.toggle(\'open\');\n                isOpen = panel.classList.contains(\'open\');\n            }\n\n            // Persist State\n            localStorage.setItem(\'detailPanelOpen\', isOpen);\n\n            // If now open, restore width\n            if (isOpen) {\n                restorePanelWidth(panel);\n            } else {\n                panel.style.width = \'\';\n            }\n        };\n\n        // --- 3. DATAGRID ROW INTERACTIONS ---\n        let activeRow = null;\n\n        window.handleRowClick = function (evt, row) {\n            // 1. Visual Highlight\n            if (activeRow) activeRow.classList.remove(\'active-row\');\n            activeRow = row;\n            activeRow.classList.add(\'active-row\');\n\n            // 2. Open Panel Immediately\n            const panel = document.getElementById(\'detailSidebar\');\n            if (panel && !panel.classList.contains(\'open\')) {\n                toggleDetailPanel(true);\n            }\n\n            // 3. Show Spinner (Optional, if we want to clear old content)\n            const content = document.getElementById(\'detailSidebarContent\');\n            if (content) {\n                // Check if we are actually loading something new (HTMX allows us to know?)\n                // Simple approach: Just show spinner. HTMX will swap it out.\n                content.innerHTML = `\n                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">\n                        <div class="spinner-border text-secondary mb-3" role="status"></div>\n                        <div class="small fw-medium">Chargement...</div>\n                    </div>`;\n            }\n        };\n\n        // --- 4. ROBUST RESIZER (Lifecycle Aware) ---\n        (function () {\n            let isResizing = false;\n\n            // A. START RESIZE (Delegated)\n            document.addEventListener(\'mousedown\', function (e) {\n                if (e.target.closest(\'#resizer\')) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    startResize();\n                }\n            });\n\n            function startResize() {\n                isResizing = true;\n                // Visual & Functional Locking\n                document.body.style.cursor = \'col-resize\';\n                document.body.style.userSelect = \'none\';\n                document.body.style.webkitUserSelect = \'none\';\n\n                const resizer = document.getElementById(\'resizer\');\n                if (resizer) resizer.classList.add(\'bg-primary-subtle\');\n\n                const panel = document.getElementById(\'detailSidebar\');\n                const content = document.querySelector(\'.main-content\');\n\n                // Disable transitions during drag\n                if (panel) panel.style.transition = \'none\';\n                if (content) content.style.transition = \'none\';\n\n                window.addEventListener(\'mousemove\', onMouseMove);\n                window.addEventListener(\'mouseup\', onMouseUp);\n            }\n\n            function onMouseMove(e) {\n                if (!isResizing) return;\n                const panel = document.getElementById(\'detailSidebar\');\n                if (!panel) return;\n\n                // Right Sidebar: Width = Total - MouseX\n                const newWidth = window.innerWidth - e.clientX;\n                if (newWidth > 250 && newWidth < window.innerWidth * 0.9) {\n                    panel.style.setProperty(\'width\', newWidth + \'px\', \'important\');\n                }\n            }\n\n            function onMouseUp(e) {\n                stopResize();\n            }\n\n            function stopResize() {\n                if (!isResizing) return;\n                isResizing = false;\n\n                // Cleanup Styles\n                document.body.style.cursor = \'\';\n                document.body.style.removeProperty(\'user-select\');\n                document.body.style.removeProperty(\'-webkit-user-select\');\n\n                const resizer = document.getElementById(\'resizer\');\n                if (resizer) resizer.classList.remove(\'bg-primary-subtle\');\n\n                const panel = document.getElementById(\'detailSidebar\');\n                if (panel) {\n                    const w = parseInt(panel.style.width);\n                    if (w > 200) localStorage.setItem(\'detailPanelWidth\', w);\n\n                    panel.style.transition = \'\';\n                    const content = document.querySelector(\'.main-content\');\n                    if (content) content.style.transition = \'\';\n                }\n\n                window.removeEventListener(\'mousemove\', onMouseMove);\n                window.removeEventListener(\'mouseup\', onMouseUp);\n            }\n\n            // Safety\n            window.addEventListener(\'blur\', stopResize);\n            document.addEventListener(\'mouseleave\', stopResize);\n\n            // B. DOUBLE CLICK RESET\n            document.addEventListener(\'dblclick\', function (e) {\n                const resizer = e.target.closest(\'#resizer\');\n                if (resizer) {\n                    const panel = document.getElementById(\'detailSidebar\');\n                    if (panel) {\n                        panel.style.setProperty(\'width\', \'600px\', \'important\');\n                        localStorage.setItem(\'detailPanelWidth\', 600);\n\n                        // Feedback\n                        resizer.style.backgroundColor = \'var(--bs-primary)\';\n                        setTimeout(() => resizer.style.backgroundColor = \'\', 200);\n                    }\n                }\n            });\n\n            // C. LIFECYCLE HOOKS (Ensures Persistence)\n            function enforceState() {\n                const panel = document.getElementById(\'detailSidebar\');\n\n                // FORCE OPEN BY DEFAULT (User Requirement: "Double Tableau" always active on load)\n                if (panel) {\n                    if (panel) {\n                        // Logic removed to prevent auto-opening\n                        // restorePanelWidth(panel); // Keep restore capability if manual open\n                    }\n                }\n            }\n\n            // Run on Load and HTMX Navigation\n            document.addEventListener(\'DOMContentLoaded\', enforceState);\n            document.body.addEventListener(\'htmx:load\', enforceState);\n            document.body.addEventListener(\'htmx:afterSwap\', enforceState);\n\n            // Auto-Open on Content Load\n            document.body.addEventListener(\'htmx:afterSwap\', function (evt) {\n                if (evt.detail.target.id === \'detailSidebarContent\') {\n                    const panel = document.getElementById(\'detailSidebar\');\n                    if (panel && !panel.classList.contains(\'open\')) {\n                        toggleDetailPanel(true);\n                    }\n                }\n            });\n\n        })();\n\n    </script>\n</body>\n\n</html>'

----------------------------------------------------------------------
Ran 1 test in 1.368s

FAILED (failures=1)
Destroying test database for alias 'default'...
Found 1 test(s).
System check identified no issues (0 silenced).
